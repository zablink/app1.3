// ================================
// ZABLINK PROJECT - FINAL SCHEMA
// Complete Schema with Token System
// ================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ================================
// ENUMS
// ================================

enum Role {
  USER
  SHOP_OWNER
  CREATOR
  ADMIN
}

enum ShopStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum CreatorStatus {
  PENDING
  ACTIVE
  SUSPENDED
  REJECTED
}

enum PackageType {
  FREE
  PRO1
  PRO2
  SPECIAL
}

enum AdScope {
  NATIONAL
  PROVINCE
  AMPHURE
  TAMBON
}

enum CreatorTier {
  BRONZE    // 100 tokens/review
  SILVER    // 150 tokens/review
  GOLD      // 200 tokens/review
  PLATINUM  // 300 tokens/review
}

// ================================
// AUTHENTICATION MODELS
// ================================

model User {
  id            String    @id @default(cuid())
  email         String?   @unique
  emailVerified DateTime?
  name          String?
  image         String?
  phone         String?
  password      String?
  
  // Role & Status
  role          Role      @default(USER)
  isActive      Boolean   @default(true)
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?
  
  // Relations
  accounts      Account[]
  sessions      Session[]
  shops         Shop[]
  creator       Creator?
  
  @@index([email])
  @@index([role])
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ================================
// SHOP MODELS
// ================================

model Shop {
  id                   String                   @id @default(cuid())
  ownerId              String
  name                 String
  slug                 String?                  @unique
  description          String?                  @db.Text
  
  // Location
  address              String?
  lat                  Float?
  lng                  Float?
  location             Unsupported("geometry")?
  provinceId           Int?
  amphureId            Int?
  tambonId             Int?
  
  // Contact
  phone                String?
  email                String?
  website              String?
  lineId               String?
  
  // Categories
  categoryId           String
  
  // Images
  image                String?
  featuredImage        String?
  
  // Package & Status
  adPackageId          String?
  packageType          PackageType              @default(FREE)
  status               ShopStatus               @default(PENDING)
  
  // Settings
  has_physical_store   Boolean                  @default(true)
  show_location_on_map Boolean                  @default(false)
  
  // Token System
  tokenBalance         Int                      @default(0)
  
  // Timestamps
  createdAt            DateTime                 @default(now())
  updatedAt            DateTime                 @updatedAt
  approvedAt           DateTime?
  rejectedAt           DateTime?
  
  // Relations
  owner                User                     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  category             ShopCategory             @relation(fields: [categoryId], references: [id])
  adPackage            AdPackage?               @relation(fields: [adPackageId], references: [id])
  
  images               ShopImage[]
  links                shop_links[]
  menus                Menu[]
  analytics            Analytics[]
  
  shop_daily_hours     shop_daily_hours[]
  shop_gallery         shop_gallery[]
  shop_hours           shop_hours?
  shop_reviews         shop_reviews[]
  shop_special_hours   shop_special_hours[]
  shop_stats           shop_stats[]
  
  subscription         ShopSubscription?
  reviewRequests       ReviewRequest[]
  tokenPurchases       TokenPurchase[]
  
  @@index([ownerId])
  @@index([status])
  @@index([packageType])
  @@index([categoryId])
  @@index([slug])
  @@index([location], map: "shops_location_gix", type: Gist)
  @@map("shops")
}

model ShopCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String?  @unique
  description String?
  icon        String?
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  shops       Shop[]
  
  @@map("shop_categories")
}

model ShopImage {
  id          String   @id @default(cuid())
  shopId      String
  url         String
  isFeatured  Boolean  @default(false)
  order       Int      @default(0)
  
  createdAt   DateTime @default(now())
  
  shop        Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  
  @@index([shopId])
  @@map("shop_images")
}

model Menu {
  id        String   @id @default(cuid())
  name      String
  price     Float
  image     String?
  shopId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  shop      Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  
  @@index([shopId])
  @@map("menus")
}

model AdPackage {
  id        String   @id @default(cuid())
  name      String
  scope     AdScope
  priority  Int
  price     Float    @default(0.0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  shops     Shop[]
  
  @@map("ad_packages")
}

model Analytics {
  id     String   @id @default(cuid())
  shopId String
  date   DateTime @default(now())
  views  Int      @default(0)
  clicks Int      @default(0)
  shop   Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  
  @@index([shopId])
  @@map("analytics")
}

// ================================
// SUBSCRIPTION & PAYMENT MODELS
// ================================

model ShopSubscription {
  id              String      @id @default(cuid())
  shopId          String      @unique
  packageType     PackageType
  
  startDate       DateTime
  endDate         DateTime
  
  isActive        Boolean     @default(true)
  autoRenew       Boolean     @default(true)
  
  price           Float
  currency        String      @default("THB")
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  shop            Shop        @relation(fields: [shopId], references: [id], onDelete: Cascade)
  payments        Payment[]
  
  @@index([shopId])
  @@index([endDate])
  @@map("shop_subscriptions")
}

model Payment {
  id              String   @id @default(cuid())
  subscriptionId  String
  
  amount          Float
  currency        String   @default("THB")
  status          String   // pending, completed, failed, refunded
  
  paymentMethod   String?  // credit_card, bank_transfer, promptpay
  transactionId   String?
  
  paidAt          DateTime?
  createdAt       DateTime @default(now())
  
  subscription    ShopSubscription @relation(fields: [subscriptionId], references: [id])
  
  @@index([subscriptionId])
  @@index([status])
  @@map("payments")
}

// ================================
// TOKEN SYSTEM MODELS
// ================================

model Token {
  id          String   @id @default(cuid())
  name        String   // "Basic Token Pack", "Premium Token Pack"
  amount      Int      // 100, 500, 1000 tokens
  price       Float    // ราคาในบาท
  bonus       Int      @default(0) // โบนัสเพิ่ม
  
  isActive    Boolean  @default(true)
  displayOrder Int     @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  purchases   TokenPurchase[]
  
  @@map("tokens")
}

model TokenPurchase {
  id              String   @id @default(cuid())
  shopId          String
  tokenId         String
  
  amount          Int      // จำนวน token ที่ซื้อ
  bonus           Int      @default(0) // โบนัสที่ได้
  totalTokens     Int      // amount + bonus
  price           Float
  
  paymentMethod   String?  // credit_card, bank_transfer, promptpay
  paymentStatus   String   @default("pending") // pending, completed, failed
  transactionId   String?
  
  paidAt          DateTime?
  createdAt       DateTime @default(now())
  
  shop            Shop     @relation(fields: [shopId], references: [id])
  token           Token    @relation(fields: [tokenId], references: [id])
  
  @@index([shopId])
  @@index([tokenId])
  @@index([paymentStatus])
  @@map("token_purchases")
}

model TokenTransaction {
  id              String   @id @default(cuid())
  shopId          String?
  creatorId       String?
  
  type            String   // purchase, spend, earn, refund
  amount          Int      // จำนวน token (+ หรือ -)
  balance         Int      // balance หลังทำธุรกรรม
  
  description     String
  referenceId     String?  // อ้างอิง review_request_id, token_purchase_id
  referenceType   String?  // review_request, token_purchase
  
  createdAt       DateTime @default(now())
  
  @@index([shopId])
  @@index([creatorId])
  @@index([type])
  @@map("token_transactions")
}

model TokenPrice {
  id              String   @id @default(cuid())
  tier            CreatorTier
  tokensPerReview Int      // 100, 150, 200, 300 tokens
  
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([tier])
  @@map("token_prices")
}

// ================================
// CREATOR/REVIEWER MODELS
// ================================

model Creator {
  id              String         @id @default(cuid())
  userId          String         @unique
  displayName     String
  bio             String?        @db.Text
  
  // Contact
  phone           String?
  lineId          String?
  
  // Social Media
  tiktokUrl       String?
  youtubeUrl      String?
  facebookUrl     String?
  instagramUrl    String?
  
  // Coverage Area
  provinceId      Int
  amphureId       Int?
  tambonId        Int?
  coverageLevel   String         // tambon, amphure, province
  
  // Token System
  tier            CreatorTier    @default(BRONZE)
  tokenPrice      Int            @default(100) // tokens ต่อ review
  
  // Stats
  totalReviews    Int            @default(0)
  completedReviews Int           @default(0)
  rating          Float          @default(0)
  
  // Financial
  totalEarnings   Float          @default(0)
  availableBalance Float         @default(0)
  totalWithdrawn  Float          @default(0)
  
  // Status
  status          CreatorStatus  @default(PENDING)
  
  // Timestamps
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  approvedAt      DateTime?
  
  // Relations
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviews         ReviewRequest[]
  earnings        CreatorEarning[]
  withdrawals     CreatorWithdrawal[]
  
  @@index([userId])
  @@index([status])
  @@index([provinceId])
  @@index([tier])
  @@map("creators")
}

model ReviewRequest {
  id              String   @id @default(cuid())
  shopId          String
  creatorId       String?
  
  title           String
  description     String   @db.Text
  budget          Float
  deadline        DateTime
  
  status          String   @default("pending") // pending, assigned, in_progress, completed, cancelled
  
  // Token System
  tokenCost       Int?
  tokensRefunded  Boolean  @default(false)
  
  // Results
  reviewUrl       String?
  completedAt     DateTime?
  shopRating      Int?     // 1-5 stars from shop owner
  shopFeedback    String?  @db.Text
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  shop            Shop     @relation(fields: [shopId], references: [id])
  creator         Creator? @relation(fields: [creatorId], references: [id])
  
  @@index([shopId])
  @@index([creatorId])
  @@index([status])
  @@map("review_requests")
}

model CreatorEarning {
  id              String   @id @default(cuid())
  creatorId       String
  reviewRequestId String?
  
  amount          Float
  description     String
  
  createdAt       DateTime @default(now())
  
  creator         Creator  @relation(fields: [creatorId], references: [id])
  
  @@index([creatorId])
  @@map("creator_earnings")
}

model CreatorWithdrawal {
  id              String   @id @default(cuid())
  creatorId       String
  
  amount          Float
  status          String   @default("pending") // pending, processing, completed, rejected
  
  bankName        String
  bankAccount     String
  accountName     String
  
  processedAt     DateTime?
  completedAt     DateTime?
  rejectedReason  String?
  
  createdAt       DateTime @default(now())
  
  creator         Creator  @relation(fields: [creatorId], references: [id])
  
  @@index([creatorId])
  @@index([status])
  @@map("creator_withdrawals")
}

// ================================
// BANNER & ADVERTISING MODELS
// ================================

model Banner {
  id          String   @id @default(cuid())
  title       String
  imageUrl    String
  linkUrl     String?
  
  scope       AdScope  // NATIONAL, PROVINCE, AMPHURE, TAMBON
  locationId  Int?     // province_id, amphure_id, or tambon_id
  
  displayOrder Int     @default(0)
  isActive    Boolean  @default(true)
  
  startDate   DateTime
  endDate     DateTime
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([scope])
  @@index([isActive])
  @@map("banners")
}

// ================================
// LOCATION MODELS (Thai Location Database)
// ================================

model loc_geographies {
  id            Int             @id
  name          String
  loc_provinces loc_provinces[]
  
  @@map("loc_geographies")
}

model loc_provinces {
  id              Int             @id
  name_th         String
  name_en         String
  geography_id    Int
  created_at      DateTime?       @db.Timestamp(6)
  updated_at      DateTime?       @db.Timestamp(6)
  deleted_at      DateTime?       @db.Timestamp(6)
  loc_amphures    loc_amphures[]
  loc_geographies loc_geographies @relation(fields: [geography_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  
  @@map("loc_provinces")
}

model loc_amphures {
  id            Int           @id
  name_th       String
  name_en       String
  province_id   Int
  created_at    DateTime?     @db.Timestamp(6)
  updated_at    DateTime?     @db.Timestamp(6)
  deleted_at    DateTime?     @db.Timestamp(6)
  loc_provinces loc_provinces @relation(fields: [province_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  loc_tambons   loc_tambons[]
  
  @@map("loc_amphures")
}

model loc_tambons {
  id           Int                      @id
  zip_code     String?
  name_th      String
  name_en      String
  amphure_id   Int
  created_at   DateTime?                @db.Timestamp(6)
  updated_at   DateTime?                @db.Timestamp(6)
  deleted_at   DateTime?                @db.Timestamp(6)
  geom         Unsupported("geometry")?
  loc_amphures loc_amphures             @relation(fields: [amphure_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([geom], map: "geom_idx", type: Gist)
  @@map("loc_tambons")
}

// ================================
// SHOP DETAILED MODELS
// ================================

model shop_daily_hours {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  shop_id      String
  day_of_week  Int
  is_closed    Boolean   @default(false)
  open_time    DateTime? @db.Time(6)
  close_time   DateTime? @db.Time(6)
  open_time_2  DateTime? @db.Time(6)
  close_time_2 DateTime? @db.Time(6)
  created_at   DateTime  @default(now()) @db.Timestamptz(6)
  Shop         Shop      @relation(fields: [shop_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([shop_id, day_of_week], map: "shop_daily_hours_unique")
  @@index([day_of_week], map: "shop_daily_hours_day_idx")
  @@index([shop_id])
  @@map("shop_daily_hours")
}

model shop_gallery {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  shop_id     String
  image_url   String
  is_featured Boolean   @default(false)
  uploaded_at DateTime? @default(now()) @db.Timestamptz(6)
  Shop        Shop      @relation(fields: [shop_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  
  @@index([shop_id])
  @@map("shop_gallery")
}

model shop_hours {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  shop_id            String    @unique
  is_24_hours        Boolean   @default(false)
  is_same_daily      Boolean   @default(true)
  is_closed          Boolean   @default(false)
  default_open_time  DateTime? @db.Time(6)
  default_close_time DateTime? @db.Time(6)
  created_at         DateTime  @default(now()) @db.Timestamptz(6)
  updated_at         DateTime  @default(now()) @db.Timestamptz(6)
  Shop               Shop      @relation(fields: [shop_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([shop_id])
  @@map("shop_hours")
}

model shop_links {
  id      String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  shop_id String
  type    String
  url     String
  Shop    Shop   @relation(fields: [shop_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  
  @@index([shop_id])
  @@map("shop_links")
}

model shop_reviews {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  shop_id     String
  user_id     String?
  rating      Int       @db.SmallInt
  comment     String?
  is_disabled Boolean   @default(false)
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  Shop        Shop      @relation(fields: [shop_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  
  @@index([shop_id])
  @@map("shop_reviews")
}

model shop_special_hours {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  shop_id      String
  special_date DateTime  @db.Date
  is_closed    Boolean   @default(false)
  reason       String?
  open_time    DateTime? @db.Time(6)
  close_time   DateTime? @db.Time(6)
  created_at   DateTime  @default(now()) @db.Timestamptz(6)
  Shop         Shop      @relation(fields: [shop_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([shop_id, special_date], map: "shop_special_hours_unique")
  @@index([special_date], map: "shop_special_hours_date_idx")
  @@index([shop_id])
  @@map("shop_special_hours")
}

model shop_stats {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  shop_id    String
  event_type String
  user_id    String?
  session_id String?
  ip_address String?
  user_agent String?
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  Shop       Shop      @relation(fields: [shop_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([event_type], map: "shop_stats_event_idx")
  @@index([shop_id])
  @@map("shop_stats")
}


// TOKEN BALANCE
// -- Token System Schema
// -- เพิ่มเข้าไปใน Prisma Schema

// -- ================================
// -- TOKEN MODELS
// -- ================================

model TokenBalance {
  id              String   @id @default(cuid())
  shopId          String   @unique
  
  // Current balance
  totalTokens     Int      @default(0)
  usedTokens      Int      @default(0)
  availableTokens Int      @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  shop            Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  batches         TokenBatch[]
  transactions    TokenTransaction[]
  
  @@index([shopId])
  @@map("token_balances")
}

model TokenBatch {
  id              String   @id @default(cuid())
  balanceId       String
  
  // Batch info
  amount          Int
  remainingAmount Int
  source          String   // subscription, purchase, bonus
  
  // Expiry
  receivedAt      DateTime @default(now())
  expiresAt       DateTime
  isExpired       Boolean  @default(false)
  
  // Metadata
  subscriptionId  String?  // Link to subscription if from package
  orderId         String?  // Link to purchase order
  
  createdAt       DateTime @default(now())
  
  // Relations
  balance         TokenBalance @relation(fields: [balanceId], references: [id], onDelete: Cascade)
  
  @@index([balanceId])
  @@index([expiresAt])
  @@index([isExpired])
  @@map("token_batches")
}

model TokenTransaction {
  id              String   @id @default(cuid())
  balanceId       String
  
  // Transaction details
  type            String   // earn, spend, refund, expire, convert
  amount          Int
  balance         Int      // Balance after transaction
  
  // References
  referenceType   String?  // review_request, ad_purchase, subscription
  referenceId     String?
  
  description     String
  
  createdAt       DateTime @default(now())
  
  // Relations
  tokenBalance    TokenBalance @relation(fields: [balanceId], references: [id], onDelete: Cascade)
  
  @@index([balanceId])
  @@index([type])
  @@index([createdAt])
  @@map("token_transactions")
}

model TokenPurchase {
  id              String   @id @default(cuid())
  shopId          String
  
  // Purchase details
  amount          Int
  pricePerToken   Float
  totalPrice      Float
  discount        Float    @default(0)
  finalPrice      Float
  
  // Payment
  paymentStatus   String   @default("pending") // pending, completed, failed
  paymentMethod   String?
  paidAt          DateTime?
  
  createdAt       DateTime @default(now())
  
  // Relations
  shop            Shop     @relation(fields: [shopId], references: [id])
  
  @@index([shopId])
  @@index([paymentStatus])
  @@map("token_purchases")
}

// ================================
// UPDATE CREATOR MODEL
// ================================

model Creator {
  // ... existing fields
  
  // Add tier pricing
  tier            String   @default("micro") // micro, small, medium, large
  tokenPrice      Int      @default(80)      // Price in tokens
  
  // Add to existing model
}

// ================================
// UPDATE SHOP MODEL
// ================================

model Shop {
  // ... existing fields
  
  // Add relations
  tokenBalance    TokenBalance?
  tokenPurchases  TokenPurchase[]
  
  // Add to existing model
}

// ================================
// UPDATE REVIEWREQUEST MODEL
// ================================

model ReviewRequest {
  // ... existing fields
  
  // Add token info
  tokenCost       Int?     // Cost in tokens
  tokensRefunded  Boolean  @default(false)
  
  // Add to existing model
}

// -- ================================
// -- TRIGGERS & FUNCTIONS
// -- ================================

// -- Function: Auto-expire tokens
CREATE OR REPLACE FUNCTION expire_tokens()
RETURNS void AS $$
BEGIN
  // -- Mark expired batches
  UPDATE token_batches
  SET is_expired = true
  WHERE expires_at < NOW()
    AND is_expired = false;
    
  // -- Create expiry transactions
  INSERT INTO token_transactions (
    id, balance_id, type, amount, balance, 
    description, created_at
  )
  SELECT 
    gen_random_uuid(),
    tb.balance_id,
    'expire',
    // -- tb.remaining_amount,
    (SELECT available_tokens FROM token_balances WHERE id = tb.balance_id),
    'Token หมดอายุ ' || tb.remaining_amount || ' tokens',
    NOW()
  FROM token_batches tb
  WHERE tb.expires_at < NOW()
    AND tb.is_expired = false
    AND tb.remaining_amount > 0;
    
  // -- Update balances
  UPDATE token_balances tb
  SET 
    available_tokens = available_tokens - (
      SELECT COALESCE(SUM(remaining_amount), 0)
      FROM token_batches
      WHERE balance_id = tb.id
        AND expires_at < NOW()
        AND is_expired = false
    ),
    updated_at = NOW();
    
  // -- Zero out expired batches
  UPDATE token_batches
  SET remaining_amount = 0
  WHERE expires_at < NOW()
    AND is_expired = false;
END;
$$ LANGUAGE plpgsql;

// -- Schedule: Run daily
// -- CREATE EXTENSION IF NOT EXISTS pg_cron;
// -- SELECT cron.schedule('expire-tokens-daily', '0 0 * * *', 'SELECT expire_tokens()');

// -- Function: Spend tokens (FIFO)
CREATE OR REPLACE FUNCTION spend_tokens(
  p_balance_id TEXT,
  p_amount INT,
  p_reference_type TEXT,
  p_reference_id TEXT,
  p_description TEXT
)
RETURNS BOOLEAN AS $$
DECLARE
  v_available INT;
  v_remaining INT;
  v_batch RECORD;
  v_to_deduct INT;
BEGIN
  // -- Check available balance
  SELECT available_tokens INTO v_available
  FROM token_balances
  WHERE id = p_balance_id;
  
  IF v_available < p_amount THEN
    RAISE EXCEPTION 'Insufficient tokens';
  END IF;
  
  v_remaining := p_amount;
  
  // -- Deduct from batches (FIFO)
  FOR v_batch IN 
    SELECT * FROM token_batches
    WHERE balance_id = p_balance_id
      AND remaining_amount > 0
      AND is_expired = false
    ORDER BY received_at ASC
  LOOP
    IF v_remaining <= 0 THEN
      EXIT;
    END IF;
    
    v_to_deduct := LEAST(v_batch.remaining_amount, v_remaining);
    
    UPDATE token_batches
    SET remaining_amount = remaining_amount - v_to_deduct
    WHERE id = v_batch.id;
    
    v_remaining := v_remaining - v_to_deduct;
  END LOOP;
  
  // -- Update balance
  UPDATE token_balances
  SET 
    used_tokens = used_tokens + p_amount,
    available_tokens = available_tokens - p_amount,
    updated_at = NOW()
  WHERE id = p_balance_id;
  
  // -- Create transaction
  INSERT INTO token_transactions (
    id, balance_id, type, amount, balance,
    reference_type, reference_id, description, created_at
  )
  SELECT 
    gen_random_uuid(),
    p_balance_id,
    'spend',
    -p_amount,
    available_tokens,
    p_reference_type,
    p_reference_id,
    p_description,
    NOW()
  FROM token_balances
  WHERE id = p_balance_id;
  
  RETURN TRUE;
END;
$$ LANGUAGE plpgsql;

// -- Function: Add tokens
CREATE OR REPLACE FUNCTION add_tokens(
  p_balance_id TEXT,
  p_amount INT,
  p_source TEXT,
  p_subscription_id TEXT DEFAULT NULL,
  p_order_id TEXT DEFAULT NULL
)
RETURNS TEXT AS $$
DECLARE
  v_batch_id TEXT;
  v_expires_at TIMESTAMP;
BEGIN
  // -- Calculate expiry (3 months)
  v_expires_at := NOW() + INTERVAL '3 months';
  
  // -- Create batch
  INSERT INTO token_batches (
    id, balance_id, amount, remaining_amount,
    source, received_at, expires_at,
    subscription_id, order_id
  )
  VALUES (
    gen_random_uuid(),
    p_balance_id,
    p_amount,
    p_amount,
    p_source,
    NOW(),
    v_expires_at,
    p_subscription_id,
    p_order_id
  )
  RETURNING id INTO v_batch_id;
  
  // -- Update balance
  UPDATE token_balances
  SET 
    total_tokens = total_tokens + p_amount,
    available_tokens = available_tokens + p_amount,
    updated_at = NOW()
  WHERE id = p_balance_id;
  
  // -- Create transaction
  INSERT INTO token_transactions (
    id, balance_id, type, amount, balance,
    description, created_at
  )
  SELECT 
    gen_random_uuid(),
    p_balance_id,
    'earn',
    p_amount,
    available_tokens,
    'ได้รับ ' || p_amount || ' tokens จาก ' || p_source,
    NOW()
  FROM token_balances
  WHERE id = p_balance_id;
  
  RETURN v_batch_id;
END;
$$ LANGUAGE plpgsql;

// -- ================================
// -- PRICING CONFIGURATION
// -- ================================

CREATE TABLE IF NOT EXISTS token_pricing (
  id TEXT PRIMARY KEY DEFAULT gen_random_uuid(),
  tier TEXT NOT NULL, // -- subscription or purchase
  min_amount INT,
  max_amount INT,
  price_per_token DECIMAL(10,2) NOT NULL,
  discount_percent DECIMAL(5,2) DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW()
);

// -- Subscription token allocation
INSERT INTO token_pricing (tier, min_amount, max_amount, price_per_token, discount_percent) VALUES
  ('FREE', 0, 0, 0, 0),
  ('BASIC', 5, 5, 0, 0),      // -- Included in package
  ('PRO', 10, 10, 0, 0),       // -- Included in package
  ('PREMIUM', 20, 20, 0, 0);   // -- Included in package

// -- Purchase pricing (example - adjust as needed)
INSERT INTO token_pricing (tier, min_amount, max_amount, price_per_token, discount_percent) VALUES
  ('purchase_small', 1, 99, 10.00, 0),
  ('purchase_medium', 100, 499, 9.00, 10),
  ('purchase_large', 500, NULL, 8.00, 20);