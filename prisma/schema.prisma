generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model ShopSubscription {
  id                       String                @id @default(dbgenerated("(gen_random_uuid())::text"))
  shop_id                  String
  package_id               String
  start_date               DateTime              @db.Date
  end_date                 DateTime              @db.Date
  status                   subscription_status?  @default(ACTIVE)
  original_price           Decimal               @db.Decimal(10, 2)
  discount_amount          Decimal?              @default(0) @db.Decimal(10, 2)
  final_price              Decimal               @db.Decimal(10, 2)
  payment_status           String?               @default("PENDING")
  paid_at                  DateTime?             @db.Timestamptz(6)
  auto_renew               Boolean?              @default(true)
  cancelled_at             DateTime?             @db.Timestamptz(6)
  cancellation_reason      String?
  parent_subscription_id   String?
  renewal_count            Int?                  @default(1)
  created_at               DateTime?             @default(now()) @db.Timestamptz(6)
  updated_at               DateTime?             @default(now()) @db.Timestamptz(6)
  subscription_packages    subscription_packages @relation(fields: [package_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  shop_subscriptions       ShopSubscription?     @relation("shop_subscriptionsToshop_subscriptions", fields: [parent_subscription_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  other_shop_subscriptions ShopSubscription[]    @relation("shop_subscriptionsToshop_subscriptions")
  Shop                     Shop                  @relation(fields: [shop_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([start_date, end_date], map: "shop_subscriptions_dates_idx")
  @@index([package_id], map: "shop_subscriptions_package_idx")
  @@index([shop_id], map: "shop_subscriptions_shop_idx")
  @@index([status])
  @@map("shop_subscriptions")
}

model loc_geographies {
  id            Int             @id
  name          String
  loc_provinces loc_provinces[]

  @@map("loc_geographies")
}

model loc_provinces {
  id              Int             @id
  name_th         String
  name_en         String
  geography_id    Int
  created_at      DateTime?       @db.Timestamp(6)
  updated_at      DateTime?       @db.Timestamp(6)
  deleted_at      DateTime?       @db.Timestamp(6)
  loc_amphures    loc_amphures[]
  loc_geographies loc_geographies @relation(fields: [geography_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@map("loc_provinces")
}

model loc_amphures {
  id            Int           @id
  name_th       String
  name_en       String
  province_id   Int
  created_at    DateTime?     @db.Timestamp(6)
  updated_at    DateTime?     @db.Timestamp(6)
  deleted_at    DateTime?     @db.Timestamp(6)
  loc_provinces loc_provinces @relation(fields: [province_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  loc_tambons   loc_tambons[]

  @@map("loc_amphures")
}

model loc_tambons {
  id           Int                      @id
  zip_code     String?
  name_th      String
  name_en      String
  amphure_id   Int
  created_at   DateTime?                @db.Timestamp(6)
  updated_at   DateTime?                @db.Timestamp(6)
  deleted_at   DateTime?                @db.Timestamp(6)
  geom         Unsupported("geometry")?
  loc_amphures loc_amphures             @relation(fields: [amphure_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([geom], map: "geom_idx", type: Gist)
  @@map("loc_tambons")
}

model shop_daily_hours {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  shop_id      String
  day_of_week  Int
  is_closed    Boolean   @default(false)
  open_time    DateTime? @db.Time(6)
  close_time   DateTime? @db.Time(6)
  open_time_2  DateTime? @db.Time(6)
  close_time_2 DateTime? @db.Time(6)
  created_at   DateTime  @default(now()) @db.Timestamptz(6)
  Shop         Shop      @relation(fields: [shop_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([shop_id, day_of_week], map: "shop_daily_hours_unique")
  @@index([day_of_week], map: "shop_daily_hours_day_idx")
  @@index([shop_id])
  @@map("shop_daily_hours")
}

model shop_gallery {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  shop_id     String
  image_url   String
  is_featured Boolean   @default(false)
  uploaded_at DateTime? @default(now()) @db.Timestamptz(6)
  Shop        Shop      @relation(fields: [shop_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("shop_gallery")
}

model shop_hours {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  shop_id            String    @unique
  is_24_hours        Boolean   @default(false)
  is_same_daily      Boolean   @default(true)
  is_closed          Boolean   @default(false)
  default_open_time  DateTime? @db.Time(6)
  default_close_time DateTime? @db.Time(6)
  created_at         DateTime  @default(now()) @db.Timestamptz(6)
  updated_at         DateTime  @default(now()) @db.Timestamptz(6)
  Shop               Shop      @relation(fields: [shop_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([shop_id])
  @@map("shop_hours")
}

model shop_links {
  id      String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  shop_id String
  type    String
  url     String
  Shop    Shop   @relation(fields: [shop_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("shop_links")
}

model shop_reviews {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  shop_id     String
  user_id     String?
  rating      Int       @db.SmallInt
  comment     String?
  is_disabled Boolean   @default(false)
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  Shop        Shop      @relation(fields: [shop_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("shop_reviews")
}

model shop_special_hours {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  shop_id      String
  special_date DateTime  @db.Date
  is_closed    Boolean   @default(false)
  reason       String?
  open_time    DateTime? @db.Time(6)
  close_time   DateTime? @db.Time(6)
  created_at   DateTime  @default(now()) @db.Timestamptz(6)
  Shop         Shop      @relation(fields: [shop_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([shop_id, special_date], map: "shop_special_hours_unique")
  @@index([special_date], map: "shop_special_hours_date_idx")
  @@index([shop_id])
  @@map("shop_special_hours")
}

model shop_stats {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  shop_id    String
  event_type String
  user_id    String?
  session_id String?
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  Shop       Shop      @relation(fields: [shop_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("shop_stats")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text  
  access_token      String? @db.Text  
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id])

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model AdPackage {
  id        String   @id
  name      String
  scope     AdScope
  priority  Int
  price     Float    @default(0.0)
  createdAt DateTime @default(now())
  updatedAt DateTime
  Shop      Shop[]
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Analytics {
  id     String   @id
  shopId String
  date   DateTime @default(now())
  views  Int      @default(0)
  clicks Int      @default(0)
  Shop   Shop     @relation(fields: [shopId], references: [id])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Menu {
  id        String   @id
  name      String
  price     Float
  image     String?
  shopId    String
  createdAt DateTime @default(now())
  updatedAt DateTime
  Shop      Shop     @relation(fields: [shopId], references: [id])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Shop {
  id                   String               @id
  name                 String
  description          String?
  address              String?
  phone                String?
  email                String?
  website              String?
  logo                 String?
  ownerId              String
  categoryId           String
  adPackageId          String?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime
  status               ShopStatus           @default(PENDING)
  location             Unsupported("point")?
  province_id          Int?
  amphure_id           Int?
  tambon_id            Int?
  has_physical_store   Boolean              @default(false)
  show_location_on_map Boolean              @default(false)
  Analytics            Analytics[]
  Menu                 Menu[]
  AdPackage            AdPackage?           @relation(fields: [adPackageId], references: [id])
  ShopCategory         ShopCategory         @relation(fields: [categoryId], references: [id])
  User                 User                 @relation(fields: [ownerId], references: [id])
  shop_daily_hours     shop_daily_hours[]
  shop_gallery         shop_gallery[]
  shop_hours           shop_hours?
  links                shop_links[]
  shop_reviews         shop_reviews[]
  shop_special_hours   shop_special_hours[]
  shop_stats           shop_stats[]
  shop_subscriptions   ShopSubscription[]
  campaigns            Campaign[]

  @@index([location], map: "shops_location_gix", type: Gist)
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model ShopCategory {
  id        String   @id
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime
  Shop      Shop[]
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model User {
  id            String    @id @default(cuid())
  email         String?   @unique
  emailVerified DateTime?
  name          String?
  createdAt     DateTime  @default(now())
  image         String?
  password      String?
  role          Role      @default(USER)
  updatedAt     DateTime  @updatedAt
  account       Account[]
  session       Session[]
  shop          Shop[]
  creator       Creator?

  @@map("users")
}

model banners {
  id         Int       @id @default(autoincrement())
  image      String
  link       String?
  order      Int?      @default(0)
  is_active  Boolean?  @default(true)
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  updated_at DateTime? @default(now()) @db.Timestamptz(6)

  @@index([order])
}

model simple_shops {
  id          Int       @id @default(autoincrement())
  name        String
  category    String?
  image       String?
  lat         Float?
  lng         Float?
  subdistrict String?
  district    String?
  province    String?
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  updated_at  DateTime? @default(now()) @db.Timestamptz(6)

  @@index([category])
  @@index([province])
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model spatial_ref_sys {
  srid      Int     @id
  auth_name String? @db.VarChar(256)
  auth_srid Int?
  srtext    String? @db.VarChar(2048)
  proj4text String? @db.VarChar(2048)
}

model subscription_packages {
  id                         String             @id @default(dbgenerated("(gen_random_uuid())::text"))
  tier                       subscription_tier  @unique
  name                       String
  price_monthly              Decimal            @db.Decimal(10, 2)
  display_order              Int
  display_weight             Int
  badge_text                 String?
  badge_emoji                String?
  max_images                 Int?               @default(1)
  max_menu_items             Int?               @default(5)
  max_delivery_links         Int?               @default(1)
  max_promotions             Int?               @default(0)
  analytics_retention_days   Int?               @default(0)
  has_advanced_analytics     Boolean?           @default(false)
  can_pin_on_map             Boolean?           @default(false)
  can_reply_reviews          Boolean?           @default(false)
  can_set_special_hours      Boolean?           @default(false)
  can_create_coupons         Boolean?           @default(false)
  has_verified_badge         Boolean?           @default(false)
  has_social_integration     Boolean?           @default(false)
  monthly_commission_tokens  Int?               @default(0)
  banner_ad_discount_percent Decimal?           @default(0) @db.Decimal(5, 2)
  support_level              String?            @default("EMAIL")
  is_active                  Boolean?           @default(true)
  created_at                 DateTime?          @default(now()) @db.Timestamptz(6)
  updated_at                 DateTime?          @default(now()) @db.Timestamptz(6)
  shop_subscriptions         ShopSubscription[]
}

// ========================================
// CREATOR & REVIEWER SYSTEM
// ========================================

model Creator {
  id                String   @id @default(cuid())
  userId            String   @unique
  
  // Basic Info
  displayName       String
  bio               String?  @db.Text
  phone             String
  
  // Location Coverage - Simplified to direct IDs
  coverageLevel     String   @default("tambon") // "tambon" | "amphure" | "province"
  provinceId        Int?
  amphureId         Int?
  tambonId          Int?
  
  // Social Media - JSON format for flexibility
  socialMedia       Json?    // { youtube: {url, subscribers}, facebook: {...}, instagram: {...}, tiktok: {...} }
  
  // Portfolio/Experience
  portfolioLinks    String[] // Array of links to previous work
  
  // Pricing & Experience
  hasExperience     Boolean  @default(true)  // false = ไม่เคยรับงานรีวิว
  priceRangeMin     Int?     // ราคาต่ำสุดที่เคยรับ (บาท) - from application
  priceRangeMax     Int?     // ราคาสูงสุดที่เคยรับ (บาท) - from application
  
  // Admin-set Current Pricing (after approval)
  currentPriceMin   Int?     // ราคาปัจจุบันที่ admin กำหนด
  currentPriceMax   Int?     // ราคาปัจจุบันที่ admin กำหนด
  
  // Stats
  totalReviews     Int      @default(0)
  completedReviews Int      @default(0)
  rating           Float    @default(0.0)
  
  // Financial
  totalEarnings    Float    @default(0.0)
  availableBalance Float    @default(0.0)
  totalWithdrawn   Float    @default(0.0)
  
  // Application Status
  applicationStatus CreatorStatus @default(PENDING)
  rejectReason      String?
  appliedAt         DateTime      @default(now())
  approvedAt        DateTime?
  rejectedAt        DateTime?
  
  // Relations
  user              User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  priceHistory      CreatorPriceHistory[]  // ประวัติการเปลี่ยนราคา
  campaignJobs      CampaignJob[]          // งานที่รับ
  earnings          Earning[]              // รายได้แต่ละรายการ
  withdrawals       Withdrawal[]           // การถอนเงิน
  
  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([userId])
  @@index([applicationStatus])
  @@index([currentPriceMin, currentPriceMax])
  @@index([provinceId])
  @@index([amphureId])
  @@index([tambonId])
  @@map("creators")
}

// ประวัติการเปลี่ยนราคา - สำคัญมากสำหรับคำนวนภาษี
model CreatorPriceHistory {
  id            String    @id @default(cuid())
  creatorId     String
  
  priceMin      Int       // ราคาต่ำสุดในช่วงนี้
  priceMax      Int       // ราคาสูงสุดในช่วงนี้
  
  effectiveFrom DateTime  @default(now())  // เริ่มใช้เมื่อ
  effectiveTo   DateTime? // หมดอายุเมื่อ (NULL = ยังใช้อยู่)
  
  changedBy     String    // Admin user id
  reason        String?   // เหตุผลที่เปลี่ยน
  
  creator       Creator   @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime  @default(now())
  
  @@index([creatorId, effectiveFrom])
  @@index([creatorId, effectiveTo])
  @@map("creator_price_history")
}

// ========================================
// CAMPAIGN & JOB SYSTEM
// ========================================

model Campaign {
  id          String   @id @default(cuid())
  shopId      String
  title       String
  description String?  @db.Text
  
  // Price Locking - เก็บราคาของ creator ณ เวลาสร้าง campaign (สำหรับ reference)
  creatorPriceAtCreation Int?  // ราคา ณ เวลาสร้าง campaign (optional, for auditing)
  
  // Budget & Token Management
  totalBudget       Int      // งบทั้งหมด (tokens)
  remainingBudget   Int      // งบคงเหลือ (tokens)
  
  // Campaign Settings
  targetReviewers   Int      @default(1)  // จำนวน reviewer ที่ต้องการ
  startDate         DateTime
  endDate           DateTime
  
  // Status
  status            String   @default("DRAFT") // DRAFT, ACTIVE, PAUSED, COMPLETED, CANCELLED
  
  // Relations
  shop        Shop          @relation(fields: [shopId], references: [id], onDelete: Cascade)
  jobs        CampaignJob[] // งานที่สร้างจาก campaign นี้
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([shopId])
  @@index([status])
  @@index([startDate, endDate])
  @@map("campaigns")
}

// งานที่ Creator รับ - เก็บราคาที่ตกลงกัน ณ เวลานั้น
model CampaignJob {
  id         String   @id @default(cuid())
  campaignId String
  creatorId  String
  
  // CRITICAL: ราคาที่ตกลงกัน ณ เวลารับงาน (LOCKED)
  agreedPrice      Int  // ราคาที่ใช้จริง - ใช้ตอนคำนวนภาษี/summary
  
  // Status
  status           ReviewStatus @default(PENDING)
  
  // Financial Breakdown
  tokensPaid       Int?     // จำนวน tokens ที่ร้านจ่าย
  platformCommission Int?   // ค่าคอม platform (บาท)
  creatorEarning   Int?     // รายได้สุทธิ creator (บาท)
  
  // Review/Content
  reviewLink       String?  // ลิงก์รีวิวที่ post แล้ว
  reviewNotes      String?  @db.Text // Note จาก creator
  
  // Timestamps
  createdAt    DateTime  @default(now())
  acceptedAt   DateTime? // เมื่อ creator รับงาน
  startedAt    DateTime? // เมื่อเริ่มทำงาน
  submittedAt  DateTime? // เมื่อส่งรีวิวเสร็จ
  completedAt  DateTime? // เมื่อ shop approve
  rejectedAt   DateTime? // เมื่อถูก reject
  cancelledAt  DateTime? // เมื่อถูกยกเลิก
  paidAt       DateTime? // เมื่อได้รับเงิน
  
  // Relations
  campaign     Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  creator      Creator   @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  
  @@index([campaignId])
  @@index([creatorId])
  @@index([status])
  @@index([creatorId, completedAt]) // สำหรับคำนวนรายได้
  @@index([creatorId, status])
  @@map("campaign_jobs")
}

// ========================================
// FINANCIAL TRACKING
// ========================================

model Earning {
  id            String   @id @default(cuid())
  creatorId     String
  campaignJobId String   @unique // One earning per job
  
  amount        Float    // จำนวนเงินที่ได้รับ (บาท)
  status        String   @default("PENDING") // PENDING, AVAILABLE, WITHDRAWN
  
  earnedAt      DateTime @default(now())
  availableAt   DateTime? // เมื่อพร้อมถอน (หลังจาก review period)
  
  creator       Creator  @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())
  
  @@index([creatorId])
  @@index([status])
  @@index([earnedAt])
  @@map("earnings")
}

model Withdrawal {
  id          String           @id @default(cuid())
  creatorId   String
  
  amount      Float            // จำนวนที่ถอน
  fee         Float            @default(0.0) // ค่าธรรมเนียม (ถ้ามี)
  netAmount   Float            // จำนวนสุทธิที่ได้รับ
  
  // Bank Info
  bankName    String
  bankAccount String
  accountName String
  
  status      WithdrawalStatus @default(PENDING)
  
  // Tracking
  requestedAt DateTime         @default(now())
  processedAt DateTime?
  completedAt DateTime?
  rejectedAt  DateTime?
  
  rejectionReason String?       @db.Text
  
  // Payment Proof
  slipUrl     String?          // รูปสลิปการโอนเงิน
  
  creator     Creator          @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime         @default(now())
  
  @@index([creatorId])
  @@index([status])
  @@index([requestedAt])
  @@map("withdrawals")
}

// ========================================
// ENUMS
// ========================================

enum Role {
  USER
  SHOP
  CREATOR
  MCN_MANAGER
  AD_MANAGER
  ADMIN
}

enum ShopStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum CreatorStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum PackageType {
  FREE
  PRO1
  PRO2
  SPECIAL
}

enum AdScope {
  SUBDISTRICT
  DISTRICT
  PROVINCE
  NATIONWIDE
}

enum CreatorTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum ReviewStatus {
  PENDING
  ACCEPTED
  IN_PROGRESS
  SUBMITTED
  COMPLETED
  REJECTED
  CANCELLED
}

enum WithdrawalStatus {
  PENDING
  PROCESSING
  COMPLETED
  REJECTED
}

enum subscription_status {
  ACTIVE
  EXPIRED
  CANCELLED
  SUSPENDED
}

enum subscription_tier {
  FREE
  BASIC
  PRO
  PREMIUM
}
